# WARNING - Generated by {fusen} from dev/flat_full.Rmd: do not edit by hand


#' Title: ya_get_dataset()
#' 
#' Description: Gathers information about the datasets in BPstat.
#' 
#' @param lang  A string that represents the languages supported by BPstat API. Currently only uses "PT" or "EN". Defaults to "EN"
#' 
#' @importFrom httr2 request
#' @importFrom httr2 req_user_agent
#' @importFrom httr2 req_perform
#' @importFrom httr2 resp_status
#' @importFrom httr2 resp_body_raw
#' @importFrom jsonlite fromJSON
#' @importFrom dplyr between
#' @importFrom dplyr select
#' @importFrom dplyr %>%
#' @importFrom dplyr tibble
#' @importFrom tidyr drop_na
#' @importFrom DT datatable
#' @importFrom htmltools tags
#' @importFrom utils View
#' 
#' @return A data table with the information about the BPstat domains
#' 
#' @export
#' 
#' @examples
#' #'ya_get_dataset()
ya_get_dataset <- function(lang = "EN"){

  check_language(lang)
  
  df_data <- dplyr::tibble()
  
  basepath_url <- "https://bpstat.bportugal.pt"
  
  url <- paste0(basepath_url,
                "/data/v1/domains/?lang=",
                toupper(lang))
  
  tryCatch({
    response <- httr2::request(url) %>%
      httr2::req_user_agent("YABPstat package") %>%
      httr2::req_perform()
    
    st_c <- httr2::resp_status(response)
    
    status_description <-
      check_status_code(st_c, lang)
    
    if (dplyr::between(st_c, 400, 550)) {
      stp_msg <- paste0("Estado :",
                        st_c,
                        " - ",
                        status_description,
                        ".")
      
      stop(stp_msg)
      
    } else {
      raw_response <- httr2::resp_body_raw(response)
      
      df_data <- jsonlite::fromJSON(rawToChar(raw_response))
      
      df_data <- df_data %>%
        dplyr::select(datasets_href, num_datasets) %>%
        tidyr::drop_na()
      
      
      if (lang == "EN" || lang == "en") {
        column_names <- c('Dataset URL', '\u0023 of datasets')
        
        capt <- "YABPstat: Datasets per domain"
        
        translate_to <-
          '//cdn.datatables.net/plug-ins/1.10.11/i18n/English.json'
        
      } else {
        column_names <- c('URL do dataset', 'N\u00famero de datasets')
        
        capt <- "YABPstat: Datasets por dom\u00ednio"
        
        translate_to <-
          '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese-Brasil.json'
        
      }
      
      if (commandArgs()[1] == "RStudio") {
        DT::datatable(
          data = df_data,
          style = "auto",
          class = "cell-border stripe",
          caption = htmltools::tags$caption(
            style = "caption-side: top;
                text-align: center;
                color:black;  font-size:200% ;
                padding-top: 20px;
                padding-bottom: 15px;",
            capt
          ),
          rownames = FALSE,
          colnames = column_names,
          options = list(
            columnDefs = list(list(
              className = 'dt-center', targets = c(1)
            )),
            searchHighlight = TRUE,
            search = list(regex = TRUE),
            language = list(url = translate_to)
          )
        )
      } else {
        knitr::kable(x = df_data,
                     caption = capt,
                     col.names = column_names, 
                     align = "lc", 
                     format = "pipe")
        
      }
    }
    
  }, error = function(e) {
    if (lang == "EN" || lang == "en") {
      err_msg <- paste0("Error: ",
                        "\n",
                        "Please check your internet connection.")
      
    } else {
      err_msg <- paste0("Erro: ",
                        "\n",
                        "Por favor verifique a sua liga\u00e7\u00e3o \u00e0 internet.")
      
    }
    stop(err_msg)
    
  })
  
}

