# WARNING - Generated by {fusen} from dev/flat_full.Rmd: do not edit by hand


#' Title: ya_save_dataset_item()
#' 
#' Description: A function that saves de information available about the BPstat datasets
#' 
#' @param lang  A string that represents the languages supported by BPstat API. Currently only uses "PT" or "EN". Defaults to "EN"
#' @param extension A string that represents the available extensions to save files. Currently only uses "rds" or "csv". Defaults to "rds"
#' 
#' @importFrom httr2 request
#' @importFrom httr2 req_user_agent
#' @importFrom httr2 req_perform
#' @importFrom httr2 resp_status
#' @importFrom httr2 resp_body_raw
#' @importFrom dplyr between
#' @importFrom dplyr tibble
#' @importFrom dplyr %>%
#' @importFrom jsonlite fromJSON
#' @importFrom tidyr drop_na
#' 
#' @return A file with the information about BPstat dataset items with the rds or csv extension.
#' 
#' @export
#' 
#' @examples
#' #'\dontrun{
#' #'ya_save_dataset_item()
#' #'}
ya_save_dataset_item <- function(lang = "EN", extension = "rds"){

  check_language(lang)
  
  check_extension(extension)
  
  tmp_dset_df <- dplyr::tibble()
  
  basepath_url <- "https://bpstat.bportugal.pt"
  
  url <- paste0(basepath_url,
                "/data/v1/domains/?lang=",
                toupper(lang))
  
  response <- httr2::request(url) %>% 
    httr2::req_user_agent("YABPstat package") %>% 
    httr2::req_perform()
  
  st_c <- httr2::resp_status(response)
  
  status_description <-
    check_status_code(st_c, lang)
  
  if (dplyr::between(st_c, 400, 550)) {
    stp_msg <- paste0("Estado :",
                      st_c,
                      " - ",
                      status_description,
                      ".")
    
    stop(stp_msg)
    
  } else {
    raw_response <- httr2::resp_body_raw(response)
    
    temp_df <- jsonlite::fromJSON(rawToChar(raw_response))
    
    temp_df <- temp_df %>%
      dplyr::select(datasets_href, num_datasets) %>%
      tidyr::drop_na()
    
    for (row in 1:nrow(temp_df)) {
      tmp_dset_df <- rbind(tmp_dset_df,
                           generate_datasets(temp_df$datasets_href[[row]]))
      
    }
    
    tmp_dset_df <- tmp_dset_df %>% 
      dplyr::select(label,
                   href,
                   extension.id,
                   extension.num_series,
                   extension.obs_updated_at)
    
    return(
      save_output(
        r_object = tmp_dset_df,
        file_directory = "raw",
        file_name = "bpstat_dataset_item",
        extension = extension
      )
    )
  }
  
}

